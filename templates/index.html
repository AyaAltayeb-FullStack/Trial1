<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Simple OCPP Charger UI</title>
</head>
<body>
  <h2>OCPP Test UI for Charger</h2>

  <button onclick="connect()">üîå Connect to CSMS</button><br><br>

  <button onclick="sendBootNotification()">üöó BootNotification</button>
  <button onclick="sendHeartbeat()">‚ù§Ô∏è Heartbeat</button>
  <button onclick="sendAuthorize()">‚úÖ Authorize</button>
  <button onclick="sendStartTransaction()">‚ñ∂Ô∏è StartTransaction</button>
  <button onclick="sendStopTransaction()">‚èπ StopTransaction</button>

  <p>üìù Open DevTools (F12) ‚Üí Console to view messages</p>

  <script>
    let ws;
    let transactionId = 123456;

    function connect() {
      ws = new WebSocket("ws://localhost:9000/CHARGER001");

      ws.onopen = () => {
        console.log("‚úÖ Connected to CSMS");
      };

      ws.onmessage = (event) => {
        console.log("üì® From CSMS:", event.data);

        try {
          const msg = JSON.parse(event.data);

          // ‚úÖ Handle RemoteStartTransaction request from CSMS
          if (Array.isArray(msg) && msg[0] === 2 && msg[2] === "RemoteStartTransaction") {
            const requestId = msg[1];
            const payload = msg[3];

            console.log("‚ö° RemoteStartTransaction received:", payload);

            const response = [
              3,
              requestId,
              { status: "Accepted" }
            ];

            ws.send(JSON.stringify(response));
            console.log("‚úÖ Responded with Accepted");
          }

          // üìå Save transactionId from StartTransaction response
          if (Array.isArray(msg) && msg[0] === 3 && typeof msg[2]?.transactionId !== "undefined") {
            transactionId = msg[2].transactionId;
            console.log("üìå Saved transactionId:", transactionId);
          }

        } catch (e) {
          console.error("‚ùå Failed to parse or handle CSMS message:", e);
        }
      };
    }

    function sendBootNotification() {
      const message = [
        2,
        "boot1",
        "BootNotification",
        {
          chargePointModel: "TestModel",
          chargePointVendor: "TestVendor"
        }
      ];
      ws.send(JSON.stringify(message));
      console.log("üöó BootNotification sent");
    }

    function sendHeartbeat() {
      ws.send(JSON.stringify([
        2,
        "hb1",
        "Heartbeat",
        {}
      ]));
      console.log("‚ù§Ô∏è Heartbeat sent");
    }

    function sendAuthorize() {
      ws.send(JSON.stringify([
        2,
        "auth1",
        "Authorize",
        { idTag: "valid123" }
      ]));
      console.log("‚úÖ Authorize sent");
    }

    function sendStartTransaction() {
      const message = [
        2,
        "start1",
        "StartTransaction",
        {
          connectorId: 1,
          idTag: "valid123",
          meterStart: 0,
          timestamp: new Date().toISOString()
        }
      ];
      ws.send(JSON.stringify(message));
      console.log("‚ñ∂Ô∏è StartTransaction sent");
    }

    function sendStopTransaction() {
      const message = [
        2,
        "stop1",
        "StopTransaction",
        {
          transactionId: transactionId,
          meterStop: 100,
          timestamp: new Date().toISOString()
        }
      ];
      ws.send(JSON.stringify(message));
      console.log("‚èπ StopTransaction sent");
    }
  </script>
</body>
</html>
